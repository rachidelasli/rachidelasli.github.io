H5P.DragNBar=(function(EventDispatcher){var nextInstanceIndex=0;function DragNBar(buttons,$container,$dialogContainer,options){var self=this;EventDispatcher.call(this);this.overflowThreshold=13;this.buttons=buttons;this.$container=$container;this.$dialogContainer=$dialogContainer;this.dnd=new H5P.DragNDrop(this,$container);this.dnd.snap=10;this.newElement=false;var defaultOptions={disableEditor:false,enableCopyPaste:true};options=H5P.jQuery.extend(defaultOptions,options);this.enableCopyPaste=options.enableCopyPaste;this.isEditor=!options.disableEditor;this.$blurHandlers=options.$blurHandlers?options.$blurHandlers:undefined;this.libraries=options.libraries;this.instanceIndex=nextInstanceIndex++;this.elements=[];this.dialog=new H5P.DragNBarDialog($dialogContainer,$container);this.$container.addClass('hardware-accelerated');if(this.isEditor){this.transformButtonActive=false;this.initEditor();this.initClickListeners();H5P.$window.resize(function(){self.resize();});}
this.addButtonGroup=function(buttons,$button,options){const $buttonGroup=H5P.jQuery('<li class="h5p-dragnbar-li h5p-dragnbar-button-group" data-label="Image"></li>');if(options&&options.title&&options.title!==''){H5P.jQuery('<div class="h5p-dragnbar-button-title">'+options.title+'</div>').appendTo($buttonGroup);}
const $buttonGroupButtons=H5P.jQuery('<ul class="h5p-dragnbar-button-buttons h5p-dragnbar-ul"></ul>').appendTo($buttonGroup);buttons.forEach(function(button){self.addButton(button,$buttonGroupButtons);});$buttonGroup.insertAfter($button.parent());return $buttonGroup;};}
DragNBar.prototype=Object.create(EventDispatcher.prototype);DragNBar.prototype.constructor=DragNBar;return DragNBar;})(H5P.EventDispatcher);H5P.DragNBar.prototype.initEditor=function(){var that=this;this.dnr=new H5P.DragNResize(this.$container);this.dnr.snap=10;this.dnr.on('moveResizing',function(){var offset=that.$element.offset();var position=that.$element.position();that.updateCoordinates(offset.left,offset.top,position.left,position.top);});this.dnr.on('stoppedResizing',function(){that.pressed=true;setTimeout(function(){delete that.pressed;},10);});this.dnr.on('showTransformPanel',function(){TransformPanel(true);});this.dnd.on('showTransformPanel',function(){TransformPanel(true);});this.dnr.on('hideTransformPanel',function(){if(!that.transformButtonActive){TransformPanel(false);}});this.dnd.on('hideTransformPanel',function(){if(!that.transformButtonActive){TransformPanel(false);}});function TransformPanel(show){if(that.focusedElement){that.focusedElement.contextMenu.trigger('contextMenuTransform',{showTransformPanel:show});}}
this.dnd.startMovingCallback=function(){that.dnd.min={x:0,y:0};that.dnd.max={x:that.$container.width()-that.$element.outerWidth(),y:that.$container.height()-that.$element.outerHeight()};if(that.newElement){that.dnd.adjust.x=10;that.dnd.adjust.y=10;that.dnd.min.y-=that.$list.height();}
return true;};this.dnd.stopMovingCallback=function(){var pos={};if(that.newElement){that.$container.css('overflow','');if(Math.round(parseFloat(that.$element.css('top')))<0){pos.x=(that.dnd.max.x/2);pos.y=(that.dnd.max.y/2);that.avoidOverlapping(pos,that.$element);}}
if(pos.x===undefined||pos.y===undefined){pos.x=Math.round(parseFloat(that.$element.css('left')));pos.y=Math.round(parseFloat(that.$element.css('top')));}
that.stopMoving(pos.x,pos.y);that.newElement=false;delete that.dnd.min;delete that.dnd.max;};};H5P.DragNBar.prototype.avoidOverlapping=function(pos,$element){var size=$element;if(size instanceof H5P.jQuery){size=window.getComputedStyle(size[0]);size={width:parseFloat(size.width),height:parseFloat(size.height)};}
else{$element=undefined;}
var containerStyle=window.getComputedStyle(this.$container[0]);var manX=parseFloat(containerStyle.width)-size.width;var manY=parseFloat(containerStyle.height)-size.height;var limit=16;var attempts=0;while(attempts<limit&&this.elementOverlaps(pos.x,pos.y,$element)){if(manX>0){pos.x=Math.floor(Math.random()*manX);}
if(manY>0){pos.y=Math.floor(Math.random()*manY);}
attempts++;}};H5P.DragNBar.prototype.elementOverlaps=function(x,y,$element){var self=this;x=Math.round(x/10);y=Math.round(y/10);for(var i=0;i<self.elements.length;i++){var element=self.elements[i];if($element!==undefined&&element.$element===$element){continue;}
if(x===Math.round(parseFloat(element.$element.css('left'))/10)&&y===Math.round(parseFloat(element.$element.css('top'))/10)){return true;}}
return false;};var SHIFT=16;var CTRL=17;var DELETE=46;var BACKSPACE=8;var C=67;var V=86;var LEFT=37;var UP=38;var RIGHT=39;var DOWN=40;var ctrlDown=false;var snapAmount=1;H5P.DragNBar.keydownHandler=function(event){var self=event.data.instance;var activeElement=document.activeElement;if(self.$dialogContainer.find(activeElement).length===0&&self.$dialogContainer.get(0)!==activeElement){return;}
if(event.which===CTRL){ctrlDown=true;if(self.dnd.snap!==undefined){delete self.dnd.snap;}}
if(event.which===SHIFT){snapAmount=self.dnd.snap;}
if(event.which===LEFT&&self.focusedElement){if(activeElement.contentEditable==='true'||activeElement.value!==undefined){return;}
event.preventDefault();self.moveWithKeys(-snapAmount,0);}
else if(event.which===UP&&self.focusedElement){if(activeElement.contentEditable==='true'||activeElement.value!==undefined){return;}
event.preventDefault();self.moveWithKeys(0,-snapAmount);}
else if(event.which===RIGHT&&self.focusedElement){if(activeElement.contentEditable==='true'||activeElement.value!==undefined){return;}
event.preventDefault();self.moveWithKeys(snapAmount,0);}
else if(event.which===DOWN&&self.focusedElement){if(activeElement.contentEditable==='true'||activeElement.value!==undefined){return;}
event.preventDefault();self.moveWithKeys(0,snapAmount);}
else if(event.which===C&&ctrlDown&&self.focusedElement&&self.$container.is(':visible')){self.copyHandler(event);}
else if(event.which===V&&ctrlDown&&window.localStorage&&self.$container.is(':visible')){self.pasteHandler(event);}
else if((event.which===DELETE||event.which===BACKSPACE)&&self.focusedElement&&self.$container.is(':visible')&&activeElement.tagName.toLowerCase()!=='input'){if(self.pressed===undefined){self.focusedElement.contextMenu.trigger('contextMenuRemove');event.preventDefault();}}};H5P.DragNBar.prototype.copyHandler=function(event){if(!this.enableCopyPaste){return;}
var self=event===undefined?this:event.data.instance;var elementSize=window.getComputedStyle(self.focusedElement.$element[0]);var width=parseFloat(elementSize.width);var height=parseFloat(elementSize.height)/width;width=width/(parseFloat(window.getComputedStyle(self.$container[0]).width)/100);height*=width;self.focusedElement.toClipboard(width,height);H5P.externalDispatcher.trigger('datainclipboard',{reset:false});};H5P.DragNBar.prototype.pasteHandler=function(event){var self=event===undefined?this:event.data.instance;var activeElement=document.activeElement;if(!this.enableCopyPaste||self.preventPaste||self.dialog.isOpen()||activeElement.contentEditable==='true'||activeElement.value!==undefined){return;}
if(self.$pasteButton.hasClass('disabled')){const pasteCheck=H5PEditor.canPastePlus(H5P.getClipboard(),this.libraries);if(pasteCheck.canPaste!==true){if(pasteCheck.reason==='pasteTooOld'||pasteCheck.reason==='pasteTooNew'){self.confirmPasteError(pasteCheck.description,0,function(){});}
else{H5PEditor.attachToastTo(self.$pasteButton.get(0),pasteCheck.description,{position:{horizontal:'center',vertical:'above',noOverflowX:true}});}
return;}}
var clipboardData=localStorage.getItem('h5pClipboard');if(clipboardData){try{clipboardData=JSON.parse(clipboardData);}
catch(err){console.error('Unable to parse JSON from clipboard.',err);return;}
H5P.DragNBar.updateFileUrls(clipboardData.specific,function(path){var isTmpFile=(path.substr(-4,4)==='#tmp');if(!isTmpFile&&clipboardData.contentId){if(H5PEditor.contentId){return '../'+clipboardData.contentId+'/'+path;}
else{return(H5PEditor.contentRelUrl?H5PEditor.contentRelUrl:'../content/')+clipboardData.contentId+'/'+path;}}
return path;});if(clipboardData.generic){clipboardData.generic=clipboardData.specific[clipboardData.generic];delete clipboardData.generic.subContentId;}
self.trigger('paste',clipboardData);}};H5P.DragNBar.prototype.setCanPaste=function(canPaste){canPaste=canPaste||false;if(this.$pasteButton){this.$pasteButton.toggleClass('disabled',!canPaste);}};H5P.DragNBar.prototype.confirmPasteError=function(message,top,next){var confirmReplace=new H5P.ConfirmationDialog({headerText:H5PEditor.t('core','pasteError'),dialogText:message,cancelText:' ',confirmText:H5PEditor.t('core','ok')}).appendTo(document.body);confirmReplace.on('confirmed',next);confirmReplace.show(top);};H5P.DragNBar.keypressHandler=function(event){var self=event.data.instance;if(event.which===BACKSPACE&&self.focusedElement&&self.$container.is(':visible')&&document.activeElement.tagName.toLowerCase()!=='input'){event.preventDefault();}};H5P.DragNBar.keyupHandler=function(event){var self=event.data.instance;if(event.which===CTRL){ctrlDown=false;self.dnd.snap=10;}
if(event.which===SHIFT){snapAmount=1;}
if(self.focusedElement&&(event.which===LEFT||event.which===UP||event.which===RIGHT||event.which===DOWN)){var position=self.getElementSizeNPosition();self.stopMoving(Math.round(position.left),Math.round(position.top));}};H5P.DragNBar.clickHandler=function(event){var self=event.data.instance;delete self.pressed;};H5P.DragNBar.prototype.initClickListeners=function(){var self=this;var index=self.instanceIndex;var eventData={instance:self};H5P.$body.on('keydown.dnb'+index,eventData,H5P.DragNBar.keydownHandler).on('keypress.dnb'+index,eventData,H5P.DragNBar.keypressHandler).on('keyup.dnb'+index,eventData,H5P.DragNBar.keyupHandler).on('click.dnb'+index,eventData,H5P.DragNBar.clickHandler);var $blurHandlers=this.$container;if(this.$blurHandlers){$blurHandlers=this.$blurHandlers;}
function handleBlur(){if(self.pressed!==undefined){delete self.pressed;}
else{self.blurAll();if(self.focusedElement!==undefined){delete self.focusedElement;}}}
$blurHandlers.keydown(function(e){if(e.which===9){handleBlur();}}).click(handleBlur);};H5P.DragNBar.updateFileUrls=function(params,handler){for(var prop in params){if(params.hasOwnProperty(prop)&&params[prop]instanceof Object){var obj=params[prop];if(obj.path!==undefined&&obj.mime!==undefined){obj.path=handler(obj.path);}
else{H5P.DragNBar.updateFileUrls(obj,handler);}}}};H5P.DragNBar.prototype.attach=function($wrapper){var self=this;$wrapper.html('');$wrapper.addClass('h5peditor-dragnbar');var $list=H5P.jQuery('<ul class="h5p-dragnbar-ul"></ul>').appendTo($wrapper);this.$list=$list;for(var i=0;i<this.buttons.length;i++){var button=this.buttons[i];if(i===this.overflowThreshold){const $buttonMore=H5P.jQuery('<li class="h5p-dragnbar-li"><a href="#" title="'+H5PEditor.t('H5P.DragNBar','moreElements')+'" class="h5p-dragnbar-a h5p-dragnbar-more-button"></a><ul class="h5p-dragnbar-li-ul"></ul></li>');$list=$buttonMore.appendTo($list).click(function(e){$list.stop().slideToggle(300);e.preventDefault();}).children(':first').next();H5P.jQuery(document).click(function(event){if(!H5P.jQuery(event.target).is($buttonMore.find('.h5p-dragnbar-more-button'))&&$list.css('display')!=='none'){$list.stop().slideToggle(300);}});}
this.addButton(button,$list);}
if(this.enableCopyPaste){this.$pasteButton=H5P.jQuery('<li class="h5p-dragnbar-li paste-button disabled">'+
'<a href="#" class="h5p-dragnbar-a h5p-dragnbar-paste-button" />'+
'</li>');H5P.jQuery('<span>',{'class':'h5p-dragnbar-tooltip','text':H5PEditor.t('H5P.DragNBar','paste')}).appendTo(this.$pasteButton);this.$pasteButton.find('.h5p-dragnbar-paste-button').click(function(event){event.preventDefault();self.pasteHandler();});if(this.buttons.length>this.overflowThreshold){this.$pasteButton.insertAfter($list.parent());}
else{this.$pasteButton.appendTo($list);}}
this.containTooltips();};H5P.DragNBar.prototype.addButton=function(button,$list){var that=this;const hasTitle=(button.title&&button.title!=='');const ariaLabel=hasTitle?' aria-label="'+button.title+'"':'';var $button=H5P.jQuery('<li class="h5p-dragnbar-li" data-label="Image">'+
'<a href="#" class="h5p-dragnbar-a h5p-dragnbar-'+button.id+'-button"'+ariaLabel+'></a>'+
'</li>').appendTo($list);if(hasTitle){H5P.jQuery('<span/>',{'class':'h5p-dragnbar-tooltip','text':button.title}).appendTo($button);}
let $buttonGroup;if(button.type==='group'){$buttonGroup=this.addButtonGroup(button.buttons,$button,{title:button.titleGroup});$buttonGroup.addClass('h5peditor-dragnbar-gone');H5P.jQuery(document).click(function(event){const hitButton=H5P.jQuery(event.target).is($button);const hitButtonGroup=H5P.jQuery(event.target).closest('.h5p-dragnbar-button-group').length===1;if(!hitButton&&!hitButtonGroup){$buttonGroup.toggleClass('h5peditor-dragnbar-gone',true);$button.find('.h5p-dragnbar-tooltip').toggleClass('h5peditor-dragnbar-gone',false);}});}
$button.hover(function(){that.containTooltips();}).children().click(function(){return false;}).mousedown(function(event){if(event.which!==1){return;}
if(button.type==='group'){if($buttonGroup!==undefined){const offset=parseFloat($button.closest('.h5p-dragnbar').css('padding-left'));const position=$button.position().left-$buttonGroup.position().left-offset;if(position>0){$buttonGroup.css('left',position);}
$buttonGroup.toggleClass('h5peditor-dragnbar-gone');$button.find('.h5p-dragnbar-tooltip').toggleClass('h5peditor-dragnbar-gone');}}
else{that.newElement=true;that.pressed=true;var createdElement=button.createElement();that.$element=createdElement;that.$container.css('overflow','visible');that.dnd.press(that.$element,event.pageX,0);that.focus(that.$element);}});};H5P.DragNBar.prototype.containTooltips=function(){var that=this;var containerWidth=that.$container.outerWidth();this.$list.find('.h5p-dragnbar-tooltip').each(function(){var width=H5P.jQuery(this).outerWidth();var parentWidth=H5P.jQuery(this).parents('.h5p-dragnbar-li').last().outerWidth();H5P.jQuery(this).css('left',-(width/2)+(parentWidth/2)+'px');var offsetLeft=H5P.jQuery(this).position().left+=H5P.jQuery(this).parents('.h5p-dragnbar-li').last().position().left;if(offsetLeft<=0){H5P.jQuery(this).css('left',0);}
if(offsetLeft+width>containerWidth){H5P.jQuery(this).css('left',-(width-parentWidth));}});};H5P.DragNBar.prototype.setContainer=function($container){this.$container=$container;if(this.dnd){this.dnd.$container=$container;}
if(this.dnr){this.dnr.$container=$container;}};H5P.DragNBar.prototype.stopMoving=function(left,top){top=top/(this.$container.height()/100);left=left/(this.$container.width()/100);this.$element.css({top:top+'%',left:left+'%'});if(this.stopMovingCallback!==undefined){this.stopMovingCallback(left,top);}};H5P.DragNBar.prototype.getElementSizeNPosition=function($element){$element=$element||this.focusedElement.$element;if(!$element||!$element.length){throw 'No element given';}
var size=$element[0].getBoundingClientRect();var position=window.getComputedStyle($element[0]);var containerSize=window.getComputedStyle(this.$container[0]);var sizeNPosition={width:parseFloat(size.width),height:parseFloat(size.height),left:parseFloat(position.left),top:parseFloat(position.top),containerWidth:parseFloat(containerSize.width),containerHeight:parseFloat(containerSize.height)};if(position.left.substr(-1,1)==='%'||position.top.substr(-1,1)==='%'){sizeNPosition.left*=(sizeNPosition.containerWidth/100);sizeNPosition.top*=(sizeNPosition.containerHeight/100);}
return sizeNPosition;};H5P.DragNBar.prototype.moveWithKeys=function(x,y){var withinBoundaries=function(value,min,max){if(value<min){value=min;}
if(value>max){value=max;}
return value;};var sizeNPosition=this.getElementSizeNPosition();sizeNPosition.left+=x;sizeNPosition.top+=y;sizeNPosition.left=withinBoundaries(sizeNPosition.left,0,sizeNPosition.containerWidth-sizeNPosition.width);sizeNPosition.top=withinBoundaries(sizeNPosition.top,0,sizeNPosition.containerHeight-sizeNPosition.height);this.$element.css({left:sizeNPosition.left+'px',top:sizeNPosition.top+'px',});this.dnd.trigger('showTransformPanel');this.updateCoordinates(sizeNPosition.left,sizeNPosition.top,sizeNPosition.left,sizeNPosition.top);};H5P.DragNBar.prototype.add=function($element,clipboardData,options){var self=this;options=options||{};if(this.isEditor&&!options.disableResize){this.dnr.add($element,options);}
var newElement=null;if(options.dnbElement){options.dnbElement.setElement($element);newElement=options.dnbElement;}
else{options.element=$element;options.disableCopy=!this.enableCopyPaste;newElement=new H5P.DragNBarElement(this,clipboardData,options);this.elements.push(newElement);}
$element.addClass('h5p-dragnbar-element');if(this.isEditor){if(newElement.contextMenu){newElement.contextMenu.on('contextMenuCopy',function(){self.copyHandler();});}
if($element.attr('tabindex')===undefined){$element.attr('tabindex','0');}
$element.mousedown(function(event){if(event.which!==1){return;}
self.pressed=true;self.focus($element);if(self.dnr.active!==true){self.dnd.press($element,event.pageX,event.pageY);}});}
$element.focus(function(){self.focus($element);});return newElement;};H5P.DragNBar.prototype.removeElement=function(dnbElement){dnbElement.removeElement();};H5P.DragNBar.prototype.focus=function($element){var self=this;if(this.focusedElement&&this.focusedElement.$element!==$element){this.focusedElement.blur();this.focusedElement.hideContextMenu();}
if(!$element.is(':visible')){return;}
self.$element=$element;this.dnd.setElement($element);this.focusedElement=this.getDragNBarElement($element);if(this.focusedElement){this.focusedElement.showContextMenu();this.focusedElement.focus();self.updateCoordinates();}
setTimeout(function(){self.updateCoordinates();if(self.focusedElement&&self.focusedElement.contextMenu&&self.focusedElement.contextMenu.canResize){self.focusedElement.contextMenu.updateDimensions();}},0);};H5P.DragNBar.prototype.getDragNBarElement=function($element){var foundElement;this.elements.forEach(function(element){if(element.getElement().is($element)){foundElement=element;}});return foundElement;};H5P.DragNBar.prototype.blurAll=function(){this.elements.forEach(function(element){element.blur();});delete this.focusedElement;};H5P.DragNBar.prototype.resize=function(){var self=this;this.updateCoordinates();if(self.focusedElement){self.focusedElement.resizeContextMenu(self.$element.offset().left-self.$element.parent().offset().left);}};H5P.DragNBar.prototype.updateCoordinates=function(left,top,x,y){if(!this.focusedElement){return;}
var containerPosition=this.$container.position();if(left&&top&&x&&y){left=x+containerPosition.left;top=y+containerPosition.top;this.focusedElement.updateCoordinates(left,top,x,y);}
else{var position=this.$element.position();this.focusedElement.updateCoordinates(position.left+containerPosition.left,position.top+containerPosition.top,position.left,position.top);}};H5P.DragNBar.clipboardify=function(from,params,generic){var clipboardData={from:from,specific:params};if(H5PEditor.contentId){clipboardData.contentId=H5PEditor.contentId;}
if(params[generic]){clipboardData.generic=generic;}
return clipboardData;};H5P.DragNBar.fitElementInside=function(sizeNPosition){var style={};if(sizeNPosition.left<0){style.left=sizeNPosition.left=0;}
if(sizeNPosition.width+sizeNPosition.left>sizeNPosition.containerWidth){style.left=sizeNPosition.containerWidth-sizeNPosition.width;if(style.left<0){style.left=0;style.width=sizeNPosition.containerWidth;}}
if(sizeNPosition.top<0){style.top=sizeNPosition.top=0;}
if(sizeNPosition.height+sizeNPosition.top>sizeNPosition.containerHeight){style.top=sizeNPosition.containerHeight-sizeNPosition.height;if(style.top<0){style.top=0;style.height=sizeNPosition.containerHeight;}}
return style;};H5P.DragNBar.prototype.remove=function(){var index=this.instanceIndex;H5P.$body.off('keydown.dnb'+index,H5P.DragNBar.keydownHandler).off('keypress.dnb'+index,H5P.DragNBar.keypressHandler).off('keyup.dnb'+index,H5P.DragNBar.keyupHandler).off('click.dnb'+index,H5P.DragNBar.clickHandler);};