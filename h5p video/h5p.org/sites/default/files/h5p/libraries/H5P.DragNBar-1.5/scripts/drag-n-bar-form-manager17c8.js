(function(DragNBar,EventDispatcher){DragNBar.FormManager=function(parent,l10n,customIconClass){var self=this;EventDispatcher.call(self);const formTargets=[self];let head,footer,subForm,titles,handleTransitionend,proceedButton,breadcrumbButton,alwaysShowButtons;const initialize=function(){self.isMainLibrary=!(parent instanceof H5PEditor.Library)
self.formContainer=(self.isMainLibrary?parent.$form:parent.$libraryWrapper)[0];self.formContainer.classList.add('form-manager');self.formContainer.classList.add('root-form');head=document.createElement('div');head.classList.add('form-manager-head');footer=document.createElement('div');footer.classList.add('form-manager-head');footer.classList.add('form-manager-footer');self.footer=footer;breadcrumbButton=createButton('breadcrumb-menu',l10n.expandBreadcrumbButtonLabel,self.toggleBreadcrumbMenu);breadcrumbButton.classList.add('form-manager-disabled');head.appendChild(breadcrumbButton);self.formBreadcrumbMenu=document.createElement('div');self.formBreadcrumbMenu.classList.add('form-manager-breadcrumb-menulist');head.appendChild(self.formBreadcrumbMenu);self.formBreadcrumb=document.createElement('div');self.formBreadcrumb.classList.add('form-manager-breadcrumb');head.appendChild(self.formBreadcrumb);const titles=createTitles(parent);titles.breadcrumb.classList.add('form-manager-comein');self.formBreadcrumb.appendChild(titles.breadcrumb);self.formBreadcrumbMenu.appendChild(titles.menu);proceedButton=createButton('proceed',H5PEditor.t('core','proceedButtonLabel'),function(){if(manager.exitSemiFullscreen){manager.exitSemiFullscreen();manager.exitSemiFullscreen=null;}});hideElement(proceedButton);head.appendChild(proceedButton);self.formButtons=document.createElement('div');self.formButtons.classList.add('form-manager-buttons');self.footerFormButtons=document.createElement('div');self.footerFormButtons.classList.add('form-manager-buttons');hideElement(self.footerFormButtons);hideElement(self.formButtons);footer.appendChild(self.footerFormButtons);head.appendChild(self.formButtons);self.formButtons.appendChild(createButton('delete',l10n.deleteButtonLabel,function(){const e=new H5P.Event('formremove');e.data=formTargets.length;formTargets[formTargets.length-1].trigger(e);if(!e.preventRemove&&formTargets.length>1){closeForm();}}));self.formButtons.appendChild(createButton('done',l10n.doneButtonLabel,function(){formTargets[formTargets.length-1].trigger('formdone',formTargets.length);if(formTargets.length>1){closeForm();}}));self.footerFormButtons.appendChild(createButton('done',l10n.doneButtonLabel,function(){formTargets[formTargets.length-1].trigger('formdone',formTargets.length);if(formTargets.length>1){closeForm();}}));self.footerFormButtons.appendChild(createButton('delete',l10n.deleteButtonLabel,function(){const e=new H5P.Event('formremove');e.data=formTargets.length;formTargets[formTargets.length-1].trigger(e);if(!e.preventRemove&&formTargets.length>1){closeForm();}}));if(self.isMainLibrary&&H5PEditor.semiFullscreen!==undefined){const fullscreenButton=createButton('fullscreen','',function(){if(manager.exitSemiFullscreen){manager.exitSemiFullscreen();}
else{manager.exitSemiFullscreen=H5PEditor.semiFullscreen([manager.formContainer],function(){if(!subForm){showElement(proceedButton);}
toggleFullscreenButtonState(fullscreenButton,true);self.trigger('formentersemifullscreen');},function(){manager.exitSemiFullscreen=null;if(!subForm){hideElement(proceedButton);}
toggleFullscreenButtonState(fullscreenButton);self.trigger('formexitsemifullscreen');});}});toggleFullscreenButtonState(fullscreenButton);head.appendChild(fullscreenButton);}
window.addEventListener('resize',self.updateFormResponsiveness);self.on('remove',function(){window.removeEventListener('resize',self.updateFormResponsiveness);});const overlay=document.createElement('div');overlay.classList.add('form-mananger-overlay');self.formContainer.insertBefore(overlay,self.formContainer.firstChild);self.formContainer.insertBefore(head,self.formContainer.firstChild);hideElement(footer);self.formContainer.appendChild(manager.footer);self.on('validate',function(){if(parent.metadata&&(!parent.metadata.title||!H5P.trim(parent.metadata.title))){self.closeFormUntil(0);}});};const createButton=function(id,text,clickHandler){const button=document.createElement('button');button.setAttribute('type','button');button.classList.add('form-manager-button');button.classList.add('form-manager-'+id);button.setAttribute('aria-label',text);button.addEventListener('click',clickHandler);const content=document.createElement('span');content.classList.add('form-manager-button-inner');content.innerText=text
content.tabIndex=-1;button.appendChild(content);return button;};const createTitles=function(libraryField,customTitle,customIconId){const library=(libraryField.params&&libraryField.params.library)?libraryField.params.library:(libraryField.currentLibrary?libraryField.currentLibrary:undefined);const title=document.createElement('div');title.classList.add('form-manager-title');const menuTitle=document.createElement('div');menuTitle.classList.add('form-manager-menutitle');menuTitle.tabIndex='0';menuTitle.addEventListener('click',function(){handleBreadcrumbClick.call(title);});menuTitle.addEventListener('keypress',function(e){handleBreadcrumbKeypress.call(title,e);});const menuTitleText=document.createElement('span');menuTitleText.classList.add('form-manager-menutitle-text');menuTitle.appendChild(menuTitleText);const menuTitleTooltip=document.createElement('span');menuTitleTooltip.classList.add('form-manager-tooltip');menuTitle.appendChild(menuTitleTooltip);const textWrapper=document.createElement('span');textWrapper.classList.add('truncatable-text');textWrapper.tabIndex=-1;title.appendChild(textWrapper);const tooltip=document.createElement('span');tooltip.classList.add('form-manager-tooltip');title.appendChild(tooltip);const setTitle=function(title){textWrapper.innerText=menuTitleText.innerText=tooltip.innerText=menuTitleTooltip.innerText=title;};const getTitle=function(){if(customTitle){return customTitle;}
else if(libraryField.params&&libraryField.params.metadata&&libraryField.params.metadata.title&&libraryField.params.metadata.title.substr(0,8)!=='Untitled'||libraryField.metadata&&libraryField.metadata.title&&libraryField.metadata.title.substr(0,8)!=='Untitled'){return getText(libraryField.metadata?libraryField.metadata.title:libraryField.params.metadata.title);}
else{if(libraryField.$select!==undefined){return libraryField.$select.children(':selected').text();}
else{return H5PEditor.libraryCache[library].title;}}};setTitle(getTitle());const listenForTitleChanges=function(){if(libraryField.metadataForm){libraryField.metadataForm.on('titlechange',function(e){setTitle(getTitle());manager.updateFormResponsiveness();});}
if(textWrapper.innerText==='Loading...'){setTitle(getTitle());manager.updateFormResponsiveness();}};if(libraryField.metadataForm===undefined&&libraryField.change){libraryField.change(listenForTitleChanges);}
else{listenForTitleChanges();}
const iconId=customIconId?customIconId:library.split(' ')[0].split('.')[1].toLowerCase();title.classList.add('form-manager-icon-'+iconId);menuTitle.classList.add('form-manager-icon-'+iconId);if(customIconClass){title.classList.add('form-manager-'+customIconClass);menuTitle.classList.add('form-manager-'+customIconClass);}
return{breadcrumb:title,menu:menuTitle};};const findExistingManager=function(parent){if(parent instanceof DragNBar.FormManager){return parent.getFormManager();}
if(parent.parent){return findExistingManager(parent.parent);}
else{return self;}};const hideElement=function(element){element.classList.add('form-manager-hidden');element.setAttribute('aria-hidden',true);};const showElement=function(element){element.classList.remove('form-manager-hidden');element.removeAttribute('aria-hidden');};const toggleFullscreenButtonState=function(element,isInFullscreen){if(isInFullscreen){element.setAttribute('aria-label',H5PEditor.t('core','exitFullscreenButtonLabel'));element.classList.add('form-manager-exit');}
else{element.setAttribute('aria-label',H5PEditor.t('core','enterFullscreenButtonLabel'));element.classList.remove('form-manager-exit');}};const closeForm=function(){const activeManager=formTargets.pop();if(H5PEditor.Html){H5PEditor.Html.removeWysiwyg();}
activeManager.trigger('formclose');const activeSubForm=activeManager.popForm();if(handleTransitionend){activeSubForm.removeEventListener('transitionend',handleTransitionend);handleTransitionend=null;}
const titles=activeManager.popTitles();manager.formBreadcrumbMenu.removeChild(titles.menu);const previousBreadcrumb=titles.breadcrumb.previousSibling;previousBreadcrumb.removeEventListener('click',handleBreadcrumbClick);previousBreadcrumb.removeEventListener('keypress',handleBreadcrumbKeypress);previousBreadcrumb.classList.remove('clickable');previousBreadcrumb.removeAttribute('tabindex');const headHeight=manager.getFormHeadHeight();manager.formContainer.style.height=(activeSubForm.getBoundingClientRect().height+headHeight)+'px';if(activeSubForm.previousSibling.classList.contains('form-manager-form')){showElement(activeSubForm.previousSibling);}
else{for(let i=1;i<manager.formContainer.children.length-1;i++){showElement(manager.formContainer.children[i]);}
if(!alwaysShowButtons){hideElement(manager.formButtons);manager.formButtons.classList.remove('form-manager-comein');manager.footerFormButtons.classList.remove('form-manager-comein');hideElement(manager.footerFormButtons);hideElement(manager.footer);}
manager.formContainer.classList.add('root-form');}
activeSubForm.style.marginLeft=window.getComputedStyle(activeSubForm).marginLeft
activeSubForm.classList.add('form-manager-movable');manager.formContainer.style.height='';activeSubForm.style.height=(manager.formContainer.getBoundingClientRect().height-headHeight)+'px';onlyOnce(activeSubForm,'transitionend',function(){manager.formContainer.removeChild(activeSubForm);});activeSubForm.classList.remove('form-manager-slidein');if(titles.breadcrumb.offsetWidth===0){manager.formBreadcrumb.removeChild(titles.breadcrumb);}
else{onlyOnce(titles.breadcrumb,'transitionend',function(){manager.formBreadcrumb.removeChild(titles.breadcrumb);});titles.breadcrumb.classList.remove('form-manager-comein');}
if(!subForm){if(proceedButton&&manager.exitSemiFullscreen){showElement(proceedButton);}
if(breadcrumbButton){breadcrumbButton.classList.add('form-manager-disabled');}}
if(self.formContainer.classList.contains('mobile-menu-open')){self.toggleBreadcrumbMenu();}
manager.formButtons.scrollIntoView();};const handleBreadcrumbClick=function(){for(let i=0;i<manager.formBreadcrumb.children.length;i++){if(manager.formBreadcrumb.children[i]===this){manager.closeFormUntil(i);break;}}};const handleBreadcrumbKeypress=function(e){if(e.which===13||e.which===32){handleBreadcrumbClick.call(this);}};self.closeFormUntil=function(index){while(formTargets.length-1!==index){formTargets[formTargets.length-1].trigger('formdone');closeForm();}};self.popForm=function(){const sF=subForm;subForm=null;return sF;};self.popTitles=function(){const t=titles;titles=null;return t;};self.getFormManager=function(){return manager;};self.addFormTarget=function(target){formTargets.push(target);};self.openForm=function(libraryField,formElement,customClass,customTitle,customIconId){if(subForm){return;}
manager.formContainer.classList.remove('root-form');manager.addFormTarget(self);subForm=document.createElement('div');subForm.classList.add('form-manager-form');subForm.classList.add('form-manager-movable');if(customClass){subForm.classList.add(customClass);}
subForm.appendChild(formElement);subForm.style.height=(manager.formContainer.getBoundingClientRect().height-manager.getFormHeadHeight())+'px';manager.formContainer.appendChild(subForm);const lastBreadcrumb=manager.formBreadcrumb.lastChild;lastBreadcrumb.addEventListener('click',handleBreadcrumbClick);lastBreadcrumb.addEventListener('keypress',handleBreadcrumbKeypress);lastBreadcrumb.classList.add('clickable');lastBreadcrumb.tabIndex='0';titles=createTitles(libraryField,customTitle,customIconId);manager.formBreadcrumb.appendChild(titles.breadcrumb);manager.formBreadcrumbMenu.insertBefore(titles.menu,manager.formBreadcrumbMenu.firstChild);showElement(manager.formButtons);showElement(manager.footerFormButtons);showElement(manager.footer);manager.formContainer.appendChild(manager.footer);handleTransitionend=onlyOnce(subForm,'transitionend',function(){handleTransitionend=null;for(let i=2;i<manager.formContainer.children.length-1;i++){const child=manager.formContainer.children[i];const skipHiding=child===subForm||child.classList.contains('sp-container')||child.classList.contains('form-manager-footer');if(!skipHiding){hideElement(manager.formContainer.children[i]);}}
subForm.style.height='';subForm.style.marginLeft='';subForm.classList.remove('form-manager-movable');self.trigger('formopened');});setTimeout(function(){subForm.style.marginLeft=(parseFloat(window.getComputedStyle(manager.formContainer.children[manager.formContainer.children.length-2]).marginLeft)-20)+'px';subForm.classList.add('form-manager-slidein');titles.breadcrumb.classList.add('form-manager-comein');manager.formButtons.classList.add('form-manager-comein');manager.footerFormButtons.classList.add('form-manager-comein');manager.updateFormResponsiveness();},0);if(proceedButton&&manager.exitSemiFullscreen){hideElement(proceedButton);}
if(breadcrumbButton){breadcrumbButton.classList.remove('form-manager-disabled');}};self.isFormOpen=function(){return subForm&&!handleTransitionend;};self.getFormHeadHeight=function(){return(alwaysShowButtons?0:head.getBoundingClientRect().height);};self.toggleBreadcrumbMenu=function(){if(self.formContainer.classList.contains('mobile-menu-open')){self.formContainer.classList.remove('mobile-menu-open');breadcrumbButton.children[0].innerText=l10n.expandBreadcrumbButtonLabel;breadcrumbButton.setAttribute('aria-label',l10n.expandBreadcrumbButtonLabel);self.formBreadcrumbMenu.classList.remove('form-manager-comein');}
else{self.formContainer.classList.add('mobile-menu-open');breadcrumbButton.children[0].innerText=l10n.collapseBreadcrumbButtonLabel;breadcrumbButton.setAttribute('aria-label',l10n.collapseBreadcrumbButtonLabel);self.formBreadcrumbMenu.classList.add('form-manager-comein');}};self.updateFormResponsiveness=function(){if(head.classList.contains('mobile-view-large')){head.classList.remove('mobile-view-large');}
if(self.formContainer.classList.contains('mobile-view-small')){self.formContainer.classList.remove('mobile-view-small');}
if(head.offsetWidth<481){self.formContainer.classList.add('mobile-view-small');}
const updateActiveTooltips=function(element){let tooltipActive;for(let i=0;i<element.children.length;i++){const breadcrumbTitle=element.children[i];if(breadcrumbTitle.firstChild.offsetWidth&&breadcrumbTitle.firstChild.scrollWidth>breadcrumbTitle.firstChild.offsetWidth+1){breadcrumbTitle.classList.add('form-mananger-tooltip-active');tooltipActive=true;}
else{breadcrumbTitle.classList.remove('form-mananger-tooltip-active');}}
return tooltipActive;};if(updateActiveTooltips(self.formBreadcrumb)){head.classList.add('mobile-view-large');updateActiveTooltips(self.formBreadcrumb)}
updateActiveTooltips(self.formBreadcrumbMenu);};self.setAlwaysShowButtons=function(state){alwaysShowButtons=state;if(alwaysShowButtons){showElement(manager.formButtons);manager.formButtons.classList.add('form-manager-comein');}};const manager=findExistingManager(parent);if(manager===self){initialize();}};DragNBar.FormManager.prototype=Object.create(EventDispatcher.prototype);DragNBar.FormManager.prototype.constructor=DragNBar.FormManager;const getText=function(value){const textNode=H5PEditor.$.parseHTML(value);if(textNode!==null){return textNode[0].nodeValue;}
return value;};const onlyOnce=function(element,eventName,handler){const callback=function(){element.removeEventListener(eventName,callback);handler.apply(this,arguments);};element.addEventListener(eventName,callback);return callback;};})(H5P.DragNBar,H5P.EventDispatcher);