H5P.DragNBarContextMenu=(function($,EventDispatcher){function ContextMenu($container,DragNBarElement,hasCoordinates,disableResize,disableCopy,directionLock){var self=this;EventDispatcher.call(this);this.dnb=DragNBarElement.dnb;this.directionLock=directionLock;this.dnbElement=DragNBarElement;this.$contextMenu=$('<div>',{'class':'h5p-dragnbar-context-menu'});this.$buttons=$('<div>',{'class':'h5p-context-menu-buttons'});this.$transformPanel=$('<div>',{'class':'h5p-transform-panel hide'});this.$parent=$container;this.hasCoordinates=(hasCoordinates!==undefined?hasCoordinates:true);this.canResize=!disableResize;this.showingTransformPanel=false;this.buttons=[{name:'Edit',label:H5PEditor.t('H5P.DragNBar','editLabel')},{name:'BringToFront',label:H5PEditor.t('H5P.DragNBar','bringToFrontLabel')},{name:'SendToBack',label:H5PEditor.t('H5P.DragNBar','sendToBackLabel')},{name:'Remove',label:H5PEditor.t('H5P.DragNBar','removeLabel')}];if(!disableCopy){this.buttons.splice(1,0,{name:'Copy',label:H5PEditor.t('H5P.DragNBar','copyLabel')});}
self.on('contextMenuTransform',function(e){if(e&&e.data.showTransformPanel!==undefined){self.showingTransformPanel=e.data.showTransformPanel;}
else{self.showingTransformPanel=!self.showingTransformPanel;}
if(e.data.button==='Transform'){if(self.dnb.transformButtonActive){self.dnb.transformButtonActive=false;}
else{self.dnb.transformButtonActive=true;}}
if(e.data.showTransformPanel==false){self.dnb.transformButtonActive=false;}
self.toggleButtonsBar(!self.showingTransformPanel);self.toggleTransformPanel(self.showingTransformPanel);self.$transformButtonWrapper.toggleClass('active',self.showingTransformPanel);self.dnb.updateCoordinates();});this.updateContextMenu();}
ContextMenu.prototype=Object.create(EventDispatcher.prototype);ContextMenu.prototype.constructor=ContextMenu;ContextMenu.prototype.addCoordinates=function(){if(!this.hasCoordinates||this.$coordinates){return;}
var self=this;this.$coordinates=$('<div class="h5p-dragnbar-coordinates">'+
'<div class="h5p-dragnbar-label">'+H5PEditor.t('H5P.DragNBar','positionLabel')+'</div>'+
'<div class="h5p-dragnbar-x-container" aria-label="X position">'+
'<input class="h5p-dragnbar-x" type="text" value="0">'+
'</div>'+
'<span class="h5p-dragnbar-coordinates-separater">,</span>'+
'<div class="h5p-dragnbar-y-container" aria-label="Y position">'+
'<input class="h5p-dragnbar-y" type="text" value="0">'+
'</div>'+
'</div>').mousedown(function(){self.dnb.pressed=true;}).appendTo(this.$transformPanel);this.$x=this.$coordinates.find('.h5p-dragnbar-x');this.$y=this.$coordinates.find('.h5p-dragnbar-y');this.$x.add(this.$y).on('change keydown',function(event){if(event.type==='change'||event.which===13){var x=Number(self.$x.val());var y=Number(self.$y.val());if(!isNaN(x)&&!isNaN(y)){var min={x:0,y:0};var max={x:self.dnb.$container.width()-self.dnbElement.getElement().outerWidth(),y:self.dnb.$container.height()-self.dnbElement.getElement().outerHeight()};if(x<0){x=min.x;}
if(y<0){y=min.y;}
if(x>max.x){x=max.x;}
if(y>max.y){y=max.y;}
self.dnb.stopMoving(x,y);if(event.which===13){setTimeout(function(){event.target.focus();event.target.setSelectionRange(0,event.target.value.length);},0);}
self.dnb.updateCoordinates();}}}).click(function(event){event.target.focus();event.target.setSelectionRange(0,event.target.value.length);});};ContextMenu.prototype.updateCoordinates=function(left,top,x,y){this.$contextMenu.css({left:left,top:top});if(this.hasCoordinates){this.$x.val(Math.round(x));this.$y.val(Math.round(y));}};ContextMenu.prototype.addDimensions=function(){var self=this;self.$dimensions=$('<div/>',{'class':'h5p-dragnbar-dimensions'});$('<div/>',{'class':'h5p-dragnbar-label',appendTo:self.$dimensions,text:H5PEditor.t('H5P.DragNBar','sizeLabel')});var updateDimensions=function(type){var target=parseFloat(this.value);if(isNaN(target)){return;}
var $element=self.dnbElement.getElement();var min=H5P.DragNResize.MIN_SIZE;var containerSize=parseFloat(window.getComputedStyle(self.dnb.$container[0])[type]);var elementStyle=window.getComputedStyle($element[0]);var max=containerSize-parseFloat(elementStyle[type==='width'?'left':'top']);if(target<min){target=min;}
if(target>max){target=max;}
self['$'+type].val(Math.round(target));var padding=$element[0].getBoundingClientRect()[type]-parseFloat(elementStyle[type]);target-=padding;$element.css(type,(target/(containerSize/100))+'%');var eventData={};eventData[type]=target/self.dnb.dnr.containerEm;self.dnb.dnr.trigger('stoppedResizing',eventData);};self.$width=self.getNewInput('width',H5PEditor.t('H5P.DragNBar','widthLabel'),self.$dimensions,updateDimensions,self.directionLock==='vertical');$('<span/>',{'class':'h5p-dragnbar-dimensions-separator',text:'Ã—',appendTo:self.$dimensions});self.$height=self.getNewInput('height',H5PEditor.t('H5P.DragNBar','heightLabel'),self.$dimensions,updateDimensions,self.directionLock==='horizontal');self.dnb.dnr.on('moveResizing',function(){self.updateDimensions();});self.$dimensions.appendTo(self.$transformPanel);};ContextMenu.prototype.addTransform=function(enableTransform){var self=this;var transformButtonObject={name:'Transform',label:H5PEditor.t('H5P.DragNBar','transformLabel')};var $transformButtonWrapper=$('<div>',{'class':'h5p-transform-button-wrapper'});if(enableTransform){self.createButton(transformButtonObject).appendTo($transformButtonWrapper);}
self.$transformButtonWrapper=$transformButtonWrapper;return $transformButtonWrapper;};ContextMenu.prototype.updateDimensions=function(){var self=this;var $element=self.dnbElement.getElement();var elementSize=window.getComputedStyle($element[0]);var paddingX=$element[0].getBoundingClientRect()['width']-parseFloat(elementSize['width']);var paddingY=$element[0].getBoundingClientRect()['height']-parseFloat(elementSize['height']);self.$width.val(Math.round(parseFloat(elementSize.width)+paddingX));self.$height.val(Math.round(parseFloat(elementSize.height)+paddingY));};ContextMenu.prototype.getNewInput=function(type,label,$container,handler,disabled){var $wrapper=$('<div/>',{'class':'h5p-dragnbar-input h5p-dragnbar-'+type,'aria-label':label,appendTo:$container});var $input=$('<input/>',{maxLength:5,disabled:disabled===true,on:{change:function(){handler.call(this,type);},keydown:function(event){if(event.which===13){handler.call(this,type);$input.focus().select();}
else if(event.which===38||event.which===40){var currentValue=parseFloat($input.val());if(!isNaN(currentValue)){$input.val(currentValue+(event.which===38?1:-1));handler.call(this,type);}}},keyup:function(event){if(event.which===38||event.which===40){$input.select();}},click:function(){$input.select();}},appendTo:$wrapper});return $input;};ContextMenu.prototype.addToMenu=function(button){var self=this;self.createButton(button).appendTo(this.$buttons);};ContextMenu.prototype.createButton=function(button){var self=this;var $newButton=$('<div>',{'class':'h5p-dragnbar-context-menu-button '+button.name.toLowerCase(),'role':'button','tabindex':0,'aria-label':button.label}).click(function(){self.dnb.pressed=true;self.trigger('contextMenu'+button.name,{button:button.name});}).keydown(function(e){var keyPressed=e.which;if(keyPressed===32){$(this).click();}});return $newButton;};ContextMenu.prototype.removeFromMenu=function(buttonName){var $removeButton=this.$buttons.children('.h5p-context-menu-button-'+buttonName);$removeButton.remove();};ContextMenu.prototype.updateContextMenu=function(){var self=this;this.$buttons.children().remove();var enableTransform=false;if(this.hasCoordinates){this.addCoordinates();enableTransform=true;}
if(this.canResize){this.addDimensions();enableTransform=true;}
this.buttons.forEach(function(button){self.addToMenu(button);});this.addTransform(enableTransform).appendTo(this.$contextMenu);this.$buttons.appendTo(this.$contextMenu);this.$transformPanel.appendTo(this.$contextMenu);};ContextMenu.prototype.addButton=function(name,label){this.buttons.push({name:name,label:label});this.updateContextMenu();};ContextMenu.prototype.removeButton=function(name){var self=this;self.buttons.forEach(function(button,index){if(button.name===name){self.buttons.splice(index,1);return;}});this.updateContextMenu();};ContextMenu.prototype.toggleButtonsBar=function(showButtons){var self=this;if(showButtons!==undefined){self.$buttons.toggleClass('hide',!showButtons);}
else{self.$buttons.toggleClass('hide');}};ContextMenu.prototype.toggleTransformPanel=function(showTransformPanel){var self=this;if(showTransformPanel!==undefined){self.$transformPanel.toggleClass('hide',!showTransformPanel);}
else{self.$transformPanel.toggleClass('hide');}};ContextMenu.prototype.toggleCoordinates=function(enableCoordinates){if(enableCoordinates===undefined){this.hasCoordinates=!this.hasCoordinates;}
else{this.hasCoordinates=!!enableCoordinates;}
this.updateContextMenu();};ContextMenu.prototype.attach=function(){this.$contextMenu.appendTo(this.$parent);};ContextMenu.prototype.detach=function(){this.$contextMenu.detach();};return ContextMenu;})(H5P.jQuery,H5P.EventDispatcher);