var H5P=H5P||{};H5P.Summary=H5P.Summary||{};H5P.Summary.XApiEventBuilder=(function($,EventDispatcher){function XApiEventDefinitionBuilder(){EventDispatcher.call(this);this.attributes={};}
XApiEventDefinitionBuilder.prototype=Object.create(EventDispatcher.prototype);XApiEventDefinitionBuilder.prototype.constructor=XApiEventDefinitionBuilder;XApiEventDefinitionBuilder.prototype.name=function(name){this.attributes.name=name;return this;};XApiEventDefinitionBuilder.prototype.description=function(description){this.attributes.description=description;return this;};XApiEventDefinitionBuilder.prototype.interactionType=function(interactionType){this.attributes.interactionType=interactionType;return this;};XApiEventDefinitionBuilder.prototype.correctResponsesPattern=function(correctResponsesPattern){this.attributes.correctResponsesPattern=correctResponsesPattern;return this;};XApiEventDefinitionBuilder.prototype.optional=function(optional){this.attributes.optional=optional;return this;};XApiEventDefinitionBuilder.prototype.build=function(){var definition={};setAttribute(definition,'name',localizeToEnUS(this.attributes.name));setAttribute(definition,'description',localizeToEnUS(this.attributes.description));setAttribute(definition,'interactionType',this.attributes.interactionType);setAttribute(definition,'correctResponsesPattern',this.attributes.correctResponsesPattern);setAttribute(definition,'type','http://adlnet.gov/expapi/activities/cmi.interaction');if(this.attributes.optional){$.extend(definition,this.attributes.optional);}
return definition;};function XApiEventResultBuilder(){EventDispatcher.call(this);this.attributes={};}
XApiEventResultBuilder.prototype=Object.create(EventDispatcher.prototype);XApiEventResultBuilder.prototype.constructor=XApiEventResultBuilder;XApiEventResultBuilder.prototype.completion=function(completion){this.attributes.completion=completion;return this;};XApiEventResultBuilder.prototype.success=function(success){this.attributes.success=success;return this;};XApiEventResultBuilder.prototype.duration=function(duration){this.attributes.duration=duration;return this;};XApiEventResultBuilder.prototype.response=function(response){this.attributes.response=(typeof response==='string')?response:response.join('[,]');return this;};XApiEventResultBuilder.prototype.score=function(score,maxScore){this.attributes.rawScore=score;this.attributes.maxScore=maxScore;return this;};XApiEventResultBuilder.prototype.build=function(){var result={};setAttribute(result,'response',this.attributes.response);setAttribute(result,'completion',this.attributes.completion);setAttribute(result,'success',this.attributes.success);if(isDefined(this.attributes.duration)){setAttribute(result,'duration','PT'+this.attributes.duration+'S');}
if(isDefined(this.attributes.rawScore)){result.score={};setAttribute(result.score,'raw',this.attributes.rawScore);if(isDefined(this.attributes.maxScore)&&this.attributes.maxScore>0){setAttribute(result.score,'min',0);setAttribute(result.score,'max',this.attributes.maxScore);setAttribute(result.score,'min',0);setAttribute(result.score,'scaled',Math.round(this.attributes.rawScore/this.attributes.maxScore*10000)/10000);}}
return result;};function XApiEventBuilder(){EventDispatcher.call(this);this.attributes={};}
XApiEventBuilder.prototype=Object.create(EventDispatcher.prototype);XApiEventBuilder.prototype.constructor=XApiEventBuilder;XApiEventBuilder.prototype.verb=function(verb){this.attributes.verb=verb;return this;};XApiEventBuilder.prototype.actor=function(name,mbox,objectType){this.attributes.actor={name:name,mbox:mbox,objectType:objectType};return this;};XApiEventBuilder.prototype.contentId=function(contentId,subContentId){this.attributes.contentId=contentId;this.attributes.subContentId=subContentId;return this;};XApiEventBuilder.prototype.context=function(parentContentId,parentSubContentId){this.attributes.parentContentId=parentContentId;this.attributes.parentSubContentId=parentSubContentId;return this;};XApiEventBuilder.prototype.result=function(result){this.attributes.result=result;return this;};XApiEventBuilder.prototype.objectDefinition=function(objectDefinition){this.attributes.objectDefinition=objectDefinition;return this;};XApiEventBuilder.prototype.build=function(){var event=new H5P.XAPIEvent();event.setActor();event.setVerb(this.attributes.verb);if(this.attributes.parentContentId||this.attributes.parentSubContentId){event.data.statement.context={'contextActivities':{'parent':[{'id':getContentXAPIId(this.attributes.parentContentId,this.attributes.parentSubContentId),'objectType':"Activity"}]}};}
event.data.statement.object={'id':getContentXAPIId(this.attributes.contentId,this.attributes.subContentId),'objectType':'Activity'};setAttribute(event.data,'actor',this.attributes.actor);setAttribute(event.data.statement,'result',this.attributes.result);setAttribute(event.data.statement.object,'definition',this.attributes.objectDefinition);if(event.data.statement.object.definition&&(this.attributes.contentId||this.attributes.subContentId)){var extensions=event.data.statement.object.definition.extensions={};setAttribute(extensions,'http://h5p.org/x-api/h5p-local-content-id',this.attributes.contentId);setAttribute(extensions,'http://h5p.org/x-api/h5p-subContentId',this.attributes.subContentId);}
return event;};var localizeToEnUS=function(str){if(str!=undefined){return{'en-US':cleanString(str)};}};var getContentXAPIId=function(contentId,subContentId){if(contentId&&H5PIntegration&&H5PIntegration.contents){var id=H5PIntegration.contents['cid-'+contentId].url;if(subContentId){id+='?subContentId='+subContentId;}
return id;}};var cleanString=function(str){return $('<div>'+str+'</div>').text().trim();};var isDefined=function(val){return typeof val!=='undefined';};function setAttribute(obj,key,value,required){if(isDefined(value)){obj[key]=value;}else if(required){console.error("xApiEventBuilder: No value for ["+key+"] in",obj);}}
XApiEventBuilder.create=function(){return new XApiEventBuilder();};XApiEventBuilder.createDefinition=function(){return new XApiEventDefinitionBuilder();};XApiEventBuilder.createResult=function(){return new XApiEventResultBuilder();};XApiEventBuilder.createChoice=function(id,description){return{id:id,description:localizeToEnUS(description)};};XApiEventBuilder.createCorrectResponsePattern=function(ids){return ids.join('[,]');};XApiEventBuilder.interactionTypes={CHOICE:'choice',COMPOUND:'compound',FILL_IN:'fill-in',MATCHING:'matching',TRUE_FALSE:'true-false'};XApiEventBuilder.verbs={ANSWERED:'answered'};return XApiEventBuilder;})(H5P.jQuery,H5P.EventDispatcher);